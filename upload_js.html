<!DOCTYPE html>
<html lang="en">
        <head>
                <meta charset="utf-8">
                <title>upload</title>
        </head>
        <body>
                <center>
                <h4>file_uploader version 0.1 (alpha)</h4>
                <form action=""
                      method="post"
                      enctype="multipart/form-data">
                        <input name="file" type="file" id="file_name" onchange="file_change();"/>
                        <input name="upload" value="upload" type="button" onclick="upload_file();" />
                        <input name="abort" value="cancel" type="button" onclick="upload_abort();" />
                </form>
                <div>
                        <div id="fileName"></div>
                        <div id="fileSize"></div>
                        <div id="fileType"></div>
                        <progress id="progress" style="margin-top:10px"></progress>
                        <span id="prozent"></span>
                        <div id="data_transfered"></span>
                </div>
                <div align="right">
                        Powered by
                        <a href="https://freedns.afraid.org/">freedns.afraid.org</a>
                        and
                        <a href="http://www.vim.org/">Vim</a>
                </div>

                <script type="text/javascript">

function file_change() {
        var fileList = document.getElementById("file_name").files;
        var file = fileList[0];

        if(!file)
                return;

        document.getElementById("fileName").innerHTML = 'Name: ' + file.name;
        document.getElementById("fileSize").innerHTML = 'Size: ' + format_size(file.size);
        document.getElementById("fileType").innerHTML = 'Type: ' + file.type;
        document.getElementById("progress").value = 0;
        document.getElementById("prozent").innerHTML = "0%";
}

var client = null;

function upload_file() {
        client = new XMLHttpRequest();
        var formData = new FormData();

        var file = document.getElementById("file_name").files[0];
        var prog = document.getElementById("progress");

        if(!file)
                return;

        prog.value = 0;
        prog.max = 100;

        formData.append("datei", file);

        client.onerror = function(e) {
                alert("onError");
        };

        client.onload = function(e) {
                document.getElementById("prozent").innerHTML = "100%";
                prog.value = prog.max;
        };

        client.upload.onprogress = function(e) {
                var p = Math.round(100 / e.total * e.loaded);
                var old_p = document.getElementById("progress").value;
                if (old_p != p || p == 100) {
                        document.getElementById("progress").value = p;
                        document.getElementById("prozent").innerHTML = p + "%";
                        document.getElementById("data_transfered").innerHTML = "[" + format_size(e.loaded) + "/" +  format_size(e.total) + "(" + format_size(e.total - e.loaded) + ")]";
                }
        };

        client.onabort = function(e) {
                alert("Upload canceled");
        };

        client.open("POST", "/");
        client.send(formData);
}

function format_size(bytes) {
        // cant get bigger, since javascript can only do signed 32-bit integers
        if (bytes > (1 << 23)) {
                return ((bytes >> 20) + 'mb');
        } else if (bytes > (1 << 13)) {
                return ((bytes >> 10) + 'kb');
        } else {
                return (bytes + 'b ');
        }
}

function upload_abort() {
        if(client instanceof XMLHttpRequest)
                client.abort();
}
                </script>
        </body>
</html>
